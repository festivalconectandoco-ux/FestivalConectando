<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Presupuestos y Gastos - Festival Conectando</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../festival-conectando.css">
  <style>
    .card-presupuesto {
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .table-gastos {
      font-size: 0.9rem;
    }
    .estado-activo {
      background-color: #d4edda;
    }
    .estado-pagado {
      background-color: #cfe2ff;
    }
    .text-danger-custom {
      color: #dc3545;
      font-weight: bold;
    }
    .text-success-custom {
      color: #198754;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-light">
  <div id="nav-container"></div>
  <script>
    fetch('../festival-conectando-nav.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('nav-container').innerHTML = html;
        if (window.initFestivalNavMenu) {
          window.initFestivalNavMenu();
        } else {
          setTimeout(() => {
            if (window.initFestivalNavMenu) window.initFestivalNavMenu();
          }, 200);
        }
      });
  </script>

  <div class="container-fluid py-4 px-3">
    <h2 class="mb-4">
      <span>Presupuestos y Gastos del Festival</span>
    </h2>

    <!-- Resumen de presupuesto -->
    <div class="row mb-3" id="resumenPresupuesto">
      <!-- Se llena con JavaScript -->
    </div>

    <!-- Formulario para agregar gasto -->
    <div class="card shadow mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Registrar Gasto</h5>
      </div>
      <div class="card-body">
        <form id="formPresupuesto">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="actividad" class="form-label">Actividad:</label>
              <select class="form-select" id="actividad" name="actividad" required>
                <option value="">Seleccionar...</option>
                <option value="Artistas">Artistas</option>
                <option value="Círculo de palabra">Círculo de palabra</option>
                <option value="Decoración">Decoración</option>
                <option value="Espacio">Espacio</option>
                <option value="Espacio-escenario">Espacio-escenario</option>
                <option value="Fuego">Fuego</option>
                <option value="Ingreso">Ingreso</option>
                <option value="Logística">Logística</option>
                <option value="Pagos">Pagos</option>
                <option value="Presentación e intermedios">Presentación e intermedios</option>
                <option value="Recursos logísticos">Recursos logísticos</option>
                <option value="Restaurante">Restaurante</option>
                <option value="Señalización">Señalización</option>
                <option value="Talleres">Talleres</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="tarea" class="form-label">Tarea:</label>
              <input type="text" class="form-control" id="tarea" name="tarea" placeholder="Descripción de la tarea" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="presupuesto" class="form-label">Presupuesto:</label>
              <input type="number" class="form-control" id="presupuesto" name="presupuesto" min="0" required>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="abonado" class="form-label">Abonado:</label>
              <input type="number" class="form-control" id="abonado" name="abonado" min="0" value="0">
            </div>
            <div class="col-md-4 mb-3">
              <label for="responsable" class="form-label">Responsable:</label>
              <input type="text" class="form-control" id="responsable" name="responsable">
            </div>
            <div class="col-md-4 mb-3">
              <label for="observaciones" class="form-label">Observaciones:</label>
              <textarea id="observaciones" name="observaciones" class="form-control" placeholder="Observaciones" rows="3"></textarea>
              <small class="form-text text-muted">Por favor, ingrese sus observaciones aquí.</small>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label">Agregar abono</label>
              <div class="input-group">
                <input type="number" class="form-control" id="pagoMonto" placeholder="Monto" min="0">
                <select class="form-select" id="pagoOrigen">
                  <option value="">(sin origen)</option>
                  <option value="Colchón Festival">Colchón Festival</option>
                  <option value="Boletas Extras">Boletas Extras</option>
                  <option value="Chaquetas Festival">Chaquetas Festival</option>
                  <option value="Boletas Festival Jennifer">Boletas Festival Jennifer</option>
                  <option value="Boletas Festival Camilo">Boletas Festival Camilo</option>
                  <option value="Separación boletas Jennifer">Separación boletas Jennifer</option>
                  <option value="Separación boletas Camilo">Separación boletas Camilo</option>
                  <option value="Emprendimientos">Emprendimientos</option>
                  <option value="Pendientes separaciones">Pendientes separaciones</option>
                </select>
                <input type="date" class="form-control" id="pagoFecha">
                <button type="button" id="btnAgregarPago" class="btn btn-outline-primary">Agregar</button>
              </div>
              <small class="form-text text-muted">Añade varios abonos; el Total Abonado se calculará automáticamente.</small>
              <div id="listaPagos" class="mt-2"></div>
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-success">Registrar Gasto</button>
            <button type="reset" class="btn btn-secondary">Limpiar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Resumen de reportes -->
    <div class="d-flex justify-content-end mb-2">
      <div class="btn-group" role="group" aria-label="reportes">
        <button id="btnResumenOrigen" class="btn btn-outline-primary">Resumen por Origen</button>
        <button id="btnExportExcel" class="btn btn-success">Exportar a Excel</button>
      </div>
    </div>

    <!-- Tabla de gastos registrados -->
    <div class="card shadow mb-4">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">Gastos Registrados</h5>
      </div>
      <div class="card-body">
        <div style="overflow-x: auto;">
          <table class="table table-sm table-striped table-hover table-gastos" id="tablaGastos">
            <thead class="table-light">
              <tr>
                <th>Actividad</th>
                <th>Tarea</th>
                <th>Presupuesto</th>
                <th class="text-end">Abonado</th>
                <th class="text-end">Saldo</th>
                <th>Responsable</th>
                               <th>Origen dinero</th>
                <th>Observaciones</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody id="cuerpoTabla">
              <tr><td colspan="9" class="text-center text-muted">Sin gastos registrados</td></tr>
            </tbody>
            <tfoot class="table-light">
              <tr>
                <th colspan="2">TOTAL</th>
                <th class="text-end"><strong id="totalPresupuesto">$0</strong></th>
                <th class="text-end"><strong id="totalAbonado">$0</strong></th>
                <th class="text-end"><strong id="totalSaldo">$0</strong></th>
                <th colspan="4"></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    <div id="origenResumen" class="mb-3"></div>

    <div class="row mb-3" id="reportesPresupuesto">
      <!-- Se llena con JavaScript -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="Presupuestos.js"></script>
  <script src="../festival-conectando-nav.js"></script>
  <!-- jQuery y DataTables -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
  $(document).ready(function() {
    // Solo inicializar si hay datos y columnas correctas
    var $tabla = $('#tablaGastos');
    var filas = $tabla.find('tbody tr');
    if (filas.length > 0 && filas.first().find('td').length === 9) {
      // Agregar inputs de filtro en cada columna del encabezado
      $tabla.find('thead tr').clone(true).appendTo($tabla.find('thead'));
      $tabla.find('thead tr:eq(1) th').each(function(i) {
        if (i === 8) { // Columna de acciones, sin filtro
          $(this).html('');
        } else {
          $(this).html('<input type="text" class="form-control form-control-sm" placeholder="Filtrar" />');
          $('input', this).on('keyup change', function() {
            if ($tabla.DataTable().column(i).search() !== this.value) {
              $tabla.DataTable().column(i).search(this.value).draw();
            }
          });
        }
      });
      $tabla.DataTable({
        orderCellsTop: true,
        fixedHeader: true,
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        }
      });
    }
  });
  </script>
</body>
</html>
